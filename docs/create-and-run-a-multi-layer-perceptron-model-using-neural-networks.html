<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Create and Run a Multi-Layer Perceptron Model Using Neural Networks | Using AWS EC2 Compute and S3 Storage for Model Fitting</title>
  <meta name="description" content="This is a tutorial for using AWS EC2 cmpute and S3 storage for model fitting via AWWS Management Console." />
  <meta name="generator" content="bookdown 0.12 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Create and Run a Multi-Layer Perceptron Model Using Neural Networks | Using AWS EC2 Compute and S3 Storage for Model Fitting" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a tutorial for using AWS EC2 cmpute and S3 storage for model fitting via AWWS Management Console." />
  <meta name="github-repo" content="IQSS/dss-ec2gui" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Create and Run a Multi-Layer Perceptron Model Using Neural Networks | Using AWS EC2 Compute and S3 Storage for Model Fitting" />
  
  <meta name="twitter:description" content="This is a tutorial for using AWS EC2 cmpute and S3 storage for model fitting via AWWS Management Console." />
  

<meta name="author" content="" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="explore-amazon-deep-learning-ami-and-connect-to-a-jupyter-notebook.html">
<link rel="next" href="get-the-results-locally.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; min-height: 1.25em; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; }
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
@media screen {
a.sourceLine::before { text-decoration: underline; color: initial; }
}
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.bn { color: #40a070; } /* BaseN */
code span.fl { color: #40a070; } /* Float */
code span.ch { color: #4070a0; } /* Char */
code span.st { color: #4070a0; } /* String */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.ot { color: #007020; } /* Other */
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.fu { color: #06287e; } /* Function */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code span.cn { color: #880000; } /* Constant */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.ss { color: #bb6688; } /* SpecialString */
code span.im { } /* Import */
code span.va { color: #19177c; } /* Variable */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.op { color: #666666; } /* Operator */
code span.bu { } /* BuiltIn */
code span.ex { } /* Extension */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.at { color: #7d9029; } /* Attribute */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A template for a bookdown website</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#table-of-contents"><i class="fa fa-check"></i>Table of Contents</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#authors-and-sources"><i class="fa fa-check"></i>Authors and Sources</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="aws-ec2-and-s3-services.html"><a href="aws-ec2-and-s3-services.html"><i class="fa fa-check"></i><b>1</b> AWS EC2 and S3 Services</a><ul>
<li class="chapter" data-level="1.1" data-path="aws-ec2-and-s3-services.html"><a href="aws-ec2-and-s3-services.html#ec2-services"><i class="fa fa-check"></i><b>1.1</b> EC2 Services</a></li>
<li class="chapter" data-level="1.2" data-path="aws-ec2-and-s3-services.html"><a href="aws-ec2-and-s3-services.html#s3-services"><i class="fa fa-check"></i><b>1.2</b> S3 Services</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="set-up-an-aws-account.html"><a href="set-up-an-aws-account.html"><i class="fa fa-check"></i><b>2</b> Set Up an AWS Account</a></li>
<li class="chapter" data-level="3" data-path="launch-an-amazon-deep-learning-amazon-machine-images-ami-instance.html"><a href="launch-an-amazon-deep-learning-amazon-machine-images-ami-instance.html"><i class="fa fa-check"></i><b>3</b> Launch an Amazon Deep Learning Amazon Machine Images (AMI) instance</a></li>
<li class="chapter" data-level="4" data-path="grant-an-ec2-instance-access-to-s3-bucket.html"><a href="grant-an-ec2-instance-access-to-s3-bucket.html"><i class="fa fa-check"></i><b>4</b> Grant an EC2 Instance Access to S3 Bucket</a><ul>
<li class="chapter" data-level="4.1" data-path="grant-an-ec2-instance-access-to-s3-bucket.html"><a href="grant-an-ec2-instance-access-to-s3-bucket.html#create-an-identity-and-access-management-iam-role"><i class="fa fa-check"></i><b>4.1</b> Create an Identity and Access Management (IAM) Role</a></li>
<li class="chapter" data-level="4.2" data-path="grant-an-ec2-instance-access-to-s3-bucket.html"><a href="grant-an-ec2-instance-access-to-s3-bucket.html#attach-an-iam-role-to-an-instance"><i class="fa fa-check"></i><b>4.2</b> Attach an IAM Role to an Instance</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="use-the-amazon-simple-storage-service-s3-console-to-store-and-transfer-your-data.html"><a href="use-the-amazon-simple-storage-service-s3-console-to-store-and-transfer-your-data.html"><i class="fa fa-check"></i><b>5</b> Use the Amazon Simple Storage Service (S3) Console to Store and Transfer Your Data</a><ul>
<li class="chapter" data-level="5.1" data-path="use-the-amazon-simple-storage-service-s3-console-to-store-and-transfer-your-data.html"><a href="use-the-amazon-simple-storage-service-s3-console-to-store-and-transfer-your-data.html#create-a-bucket"><i class="fa fa-check"></i><b>5.1</b> Create a Bucket</a></li>
<li class="chapter" data-level="5.2" data-path="use-the-amazon-simple-storage-service-s3-console-to-store-and-transfer-your-data.html"><a href="use-the-amazon-simple-storage-service-s3-console-to-store-and-transfer-your-data.html#upload-your-dataset"><i class="fa fa-check"></i><b>5.2</b> Upload Your Dataset</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="retrieve-the-ip-address-of-your-deep-learning-ami-instance-and-connect-to-your-deep-learning-ami-instance.html"><a href="retrieve-the-ip-address-of-your-deep-learning-ami-instance-and-connect-to-your-deep-learning-ami-instance.html"><i class="fa fa-check"></i><b>6</b> Retrieve the IP Address of Your Deep Learning AMI Instance and Connect to Your Deep Learning AMI Instance</a><ul>
<li class="chapter" data-level="6.1" data-path="retrieve-the-ip-address-of-your-deep-learning-ami-instance-and-connect-to-your-deep-learning-ami-instance.html"><a href="retrieve-the-ip-address-of-your-deep-learning-ami-instance-and-connect-to-your-deep-learning-ami-instance.html#connect-to-your-deep-learning-ami-instance-from-a-windows-machine"><i class="fa fa-check"></i><b>6.1</b> Connect to Your Deep Learning AMI Instance from a Windows Machine</a></li>
<li class="chapter" data-level="6.2" data-path="retrieve-the-ip-address-of-your-deep-learning-ami-instance-and-connect-to-your-deep-learning-ami-instance.html"><a href="retrieve-the-ip-address-of-your-deep-learning-ami-instance-and-connect-to-your-deep-learning-ami-instance.html#connect-to-your-deep-learning-ami-instance-from-a-mac-or-linux-machine"><i class="fa fa-check"></i><b>6.2</b> Connect to Your Deep Learning AMI Instance from a Mac or Linux Machine</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="explore-amazon-deep-learning-ami-and-connect-to-a-jupyter-notebook.html"><a href="explore-amazon-deep-learning-ami-and-connect-to-a-jupyter-notebook.html"><i class="fa fa-check"></i><b>7</b> Explore Amazon Deep Learning AMI and Connect to a Jupyter Notebook</a></li>
<li class="chapter" data-level="8" data-path="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><a href="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><i class="fa fa-check"></i><b>8</b> Create and Run a Multi-Layer Perceptron Model Using Neural Networks</a><ul>
<li class="chapter" data-level="8.1" data-path="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><a href="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html#install-and-import-dependencies"><i class="fa fa-check"></i><b>8.1</b> Install and Import Dependencies</a></li>
<li class="chapter" data-level="8.2" data-path="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><a href="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html#provide-utilities-related-functions"><i class="fa fa-check"></i><b>8.2</b> Provide Utilities-Related Functions</a></li>
<li class="chapter" data-level="8.3" data-path="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><a href="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html#read-data-from-s3-and-inspect-the-data"><i class="fa fa-check"></i><b>8.3</b> Read Data from S3 and Inspect the Data</a></li>
<li class="chapter" data-level="8.4" data-path="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><a href="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html#perform-the-data-processing-specific-to-neural-networks"><i class="fa fa-check"></i><b>8.4</b> Perform the Data Processing Specific to Neural Networks</a></li>
<li class="chapter" data-level="8.5" data-path="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><a href="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html#create-a-multi-layer-perceptron-model-using-neural-networks"><i class="fa fa-check"></i><b>8.5</b> Create a Multi-Layer Perceptron Model Using Neural Networks</a></li>
<li class="chapter" data-level="8.6" data-path="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><a href="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html#train-the-multi-layer-perceptron-model"><i class="fa fa-check"></i><b>8.6</b> Train the Multi-Layer Perceptron Model</a></li>
<li class="chapter" data-level="8.7" data-path="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html"><a href="create-and-run-a-multi-layer-perceptron-model-using-neural-networks.html#evaluate-the-multi-layer-perceptron-model"><i class="fa fa-check"></i><b>8.7</b> Evaluate the Multi-Layer Perceptron Model</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="get-the-results-locally.html"><a href="get-the-results-locally.html"><i class="fa fa-check"></i><b>9</b> Get the Results Locally</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Using AWS EC2 Compute and S3 Storage for Model Fitting</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="create-and-run-a-multi-layer-perceptron-model-using-neural-networks" class="section level1">
<h1><span class="header-section-number">8</span> Create and Run a Multi-Layer Perceptron Model Using Neural Networks</h1>
<p>The example below uses some basic functions from TensorFlow to create neural networks over the customized data sets stored in S3 and write the result plots to S3. The example uses AWID wireless network intrusion detection dataset with 154 features and a class label having 4 network activity type categories. The data set has been pre-processed with data transformation, normalization, and under-sampling.</p>
<div id="install-and-import-dependencies" class="section level2">
<h2><span class="header-section-number">8.1</span> Install and Import Dependencies</h2>
<ol start="88" style="list-style-type: decimal">
<li>Paste the following code into the <strong>In</strong> cell in the jupyter notebook to <strong>import dependencies</strong> into the notebook cell:</li>
</ol>
<pre class="sourceCode python" id="cb5"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="im">import</span> tensorflow <span class="im">as</span> tf</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="im">import</span> datetime</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="im">from</span> sklearn.utils <span class="im">import</span> shuffle</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="im">from</span> smart_open <span class="im">import</span> <span class="bu">open</span></a></code></pre>
<ol start="89" style="list-style-type: decimal">
<li><strong>smart_open</strong> is a Python 2 &amp; Python 3 library for efficient streaming of very large files from/to storages such as S3, HDFS, WebHDFS, HTTP, HTTPS, SFTP, or local filesystem. It builds on boto3 and other remote storage libraries but offers a clean unified Pythonic API. Unlike the other packages in the example, you need to <strong>install this package</strong> to the “tensorflow_p36” environment before you can import it in the code. To do that, go to jupyter <strong>Home</strong> tab, click <strong>Conda</strong>. Remember we have activated the “tensorflow_p36” environment.</li>
<li>Select the “<strong>smart_open</strong>” package in the left bottom plane and move it to the right bottom plane by clicking the <strong>arrow</strong> button.</li>
<li>You should see the “smart_open” package show up in the right bottom plane. Click <strong>Refresh package list</strong>.</li>
<li><strong>Repeat</strong> the steps 80-87 to make sure that the installed packages in the “tensorflow_p36” environment are fully updated.</li>
<li>Run the cell by pressing <strong>Shift+Enter</strong> or click on <strong>Run</strong>. When the cell finishes running, the number on the left of the cell will change from <strong>In[*]:</strong> to <strong>In[1]</strong>.</li>
</ol>
</div>
<div id="provide-utilities-related-functions" class="section level2">
<h2><span class="header-section-number">8.2</span> Provide Utilities-Related Functions</h2>
<ol start="94" style="list-style-type: decimal">
<li>Provide the <strong>utilities functions</strong> for reading files, checking column names, checking missing values, and transforming the class labels from a categorical variable to 4 dummy variables.</li>
</ol>
<pre class="sourceCode python" id="cb6"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Utilities-related functions</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">def</span> now():</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    tmp <span class="op">=</span> datetime.datetime.now().strftime(<span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S&quot;</span>)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="cf">return</span> tmp</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="kw">def</span> read_file(<span class="bu">file</span>):</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">        df <span class="op">=</span> pd.read_csv(<span class="bu">file</span>, index_col <span class="op">=</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">        <span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">{}</span><span class="st">: </span><span class="sc">{}</span><span class="st"> has </span><span class="sc">{}</span><span class="st"> observations and </span><span class="sc">{}</span><span class="st"> columns&quot;</span>.<span class="bu">format</span>(now(), <span class="bu">file</span>, df.shape[<span class="dv">0</span>], df.shape[<span class="dv">1</span>]))</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">        <span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">{}</span><span class="st">: Column name checking::: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(now(), df.columns.tolist()))</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">    <span class="cf">except</span> <span class="pp">MemoryError</span> <span class="im">as</span> e:</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">        <span class="bu">print</span>(e.message)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    <span class="cf">return</span> df</a>
<a class="sourceLine" id="cb6-14" data-line-number="14"></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="co"># Read data frame, check missing data, find number of missing</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="kw">def</span> check_missing(df):</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">        <span class="cf">if</span>(<span class="bu">isinstance</span>(df, pd.DataFrame)):</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">            na_pool <span class="op">=</span> pd.concat([df.isnull().<span class="bu">any</span>(), df.isnull().<span class="bu">sum</span>(), df.isnull().<span class="bu">sum</span>() <span class="op">/</span> df.shape[<span class="dv">0</span>]], axis <span class="op">=</span> <span class="dv">1</span>, keys <span class="op">=</span> [<span class="st">&quot;na_bool&quot;</span>, <span class="st">&quot;na_sum&quot;</span>, <span class="st">&quot;na_percent&quot;</span>])</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">            na_pool <span class="op">=</span> na_pool.loc[na_pool[<span class="st">&quot;na_bool&quot;</span>] <span class="op">==</span>  <span class="va">True</span>]</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">            <span class="cf">return</span> na_pool</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb6-23" data-line-number="23">            <span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">{}</span><span class="st">: The input is not panda DataFrame&quot;</span>.<span class="bu">format</span>(now()))</a>
<a class="sourceLine" id="cb6-24" data-line-number="24">    <span class="cf">except</span> (<span class="pp">UnboundLocalError</span>, <span class="pp">RuntimeError</span>):</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">        <span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">{}</span><span class="st">: The input has something wrong&quot;</span>.<span class="bu">format</span>(now()))</a>
<a class="sourceLine" id="cb6-26" data-line-number="26"></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="kw">def</span> transform(df):</a>
<a class="sourceLine" id="cb6-28" data-line-number="28">    df.loc[df.<span class="bu">type</span> <span class="op">==</span> <span class="dv">1</span>, <span class="st">&#39;isNormal&#39;</span>] <span class="op">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-29" data-line-number="29">    df.loc[df.<span class="bu">type</span> <span class="op">!=</span> <span class="dv">1</span>, <span class="st">&#39;isNormal&#39;</span>] <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30"></a>
<a class="sourceLine" id="cb6-31" data-line-number="31">    df.loc[df.<span class="bu">type</span> <span class="op">==</span> <span class="dv">2</span>, <span class="st">&#39;isImpersonation&#39;</span>] <span class="op">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-32" data-line-number="32">    df.loc[df.<span class="bu">type</span> <span class="op">!=</span> <span class="dv">2</span>, <span class="st">&#39;isImpersonation&#39;</span>] <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-33" data-line-number="33"></a>
<a class="sourceLine" id="cb6-34" data-line-number="34">    df.loc[df.<span class="bu">type</span> <span class="op">==</span> <span class="dv">3</span>, <span class="st">&#39;isFlooding&#39;</span>] <span class="op">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35">    df.loc[df.<span class="bu">type</span> <span class="op">!=</span> <span class="dv">3</span>, <span class="st">&#39;isFlooding&#39;</span>] <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-36" data-line-number="36"></a>
<a class="sourceLine" id="cb6-37" data-line-number="37">    df.loc[df.<span class="bu">type</span> <span class="op">==</span> <span class="dv">4</span>, <span class="st">&#39;isInjection&#39;</span>] <span class="op">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38">    df.loc[df.<span class="bu">type</span> <span class="op">!=</span> <span class="dv">4</span>, <span class="st">&#39;isInjection&#39;</span>] <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-39" data-line-number="39"></a>
<a class="sourceLine" id="cb6-40" data-line-number="40">    <span class="bu">print</span>(df.isNormal.value_counts())</a>
<a class="sourceLine" id="cb6-41" data-line-number="41">    <span class="bu">print</span>(df.isImpersonation.value_counts())</a>
<a class="sourceLine" id="cb6-42" data-line-number="42">    <span class="bu">print</span>(df.isFlooding.value_counts())</a>
<a class="sourceLine" id="cb6-43" data-line-number="43">    <span class="bu">print</span>(df.isInjection.value_counts())</a>
<a class="sourceLine" id="cb6-44" data-line-number="44"></a>
<a class="sourceLine" id="cb6-45" data-line-number="45">    df2 <span class="op">=</span> pd.concat([df.isNormal, df.isImpersonation, df.isFlooding, df.isInjection], axis <span class="op">=</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-46" data-line-number="46">    df1 <span class="op">=</span> df.drop([<span class="st">&#39;type&#39;</span>, <span class="st">&#39;isNormal&#39;</span>, <span class="st">&#39;isImpersonation&#39;</span>, <span class="st">&#39;isFlooding&#39;</span>, <span class="st">&#39;isInjection&#39;</span>], axis <span class="op">=</span> <span class="dv">1</span>)   </a>
<a class="sourceLine" id="cb6-47" data-line-number="47"></a>
<a class="sourceLine" id="cb6-48" data-line-number="48">    <span class="cf">return</span> df1, df2</a></code></pre>
</div>
<div id="read-data-from-s3-and-inspect-the-data" class="section level2">
<h2><span class="header-section-number">8.3</span> Read Data from S3 and Inspect the Data</h2>
<ol start="95" style="list-style-type: decimal">
<li>You need to find the <strong>Access Key</strong> and the <strong>Secret Access Key</strong>. Click on your <strong>username</strong> at the top right of the AWS Management Console page.</li>
<li>Click on the <strong>My Security Credentials</strong> link from the drop-down menu.</li>
<li>Find the <strong>Access keys (access key ID and secret access key)</strong> section and click on <strong>Create New Access Key</strong>.</li>
<li>Download the <strong>Access Key file (in .csv format)</strong> to a safe local folder for later use.</li>
<li>Paste the following code into the <strong>In</strong> cell in the jupyter notebook to read data (both training set and testing set) from S3 and then inspect the data:</li>
</ol>
<pre class="sourceCode python" id="cb7"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># Read in datafile</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">aws_key <span class="op">=</span> <span class="st">&#39;YOUR_AWS_ACCESS_KEY&#39;</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">aws_secret <span class="op">=</span> <span class="st">&#39;YOUR_AWS_SECRET_ACCESS_KEY&#39;</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">bucket_name <span class="op">=</span> <span class="st">&#39;YOUR_S3_BUCKET_NAME&#39;</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">object_train_key <span class="op">=</span> <span class="st">&#39;train.csv&#39;</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">object_test_key <span class="op">=</span> <span class="st">&#39;test.csv&#39;</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">path_train <span class="op">=</span> <span class="st">&#39;s3://</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">@</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(aws_key, aws_secret, bucket_name, object_train_key)</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">path_test <span class="op">=</span> <span class="st">&#39;s3://</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">@</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(aws_key, aws_secret, bucket_name, object_test_key)</a>
<a class="sourceLine" id="cb7-11" data-line-number="11"></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">data_trn <span class="op">=</span> read_file(smart_open(path_train))</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="bu">print</span>(check_missing(data_trn))</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">data_trn.rename(columns<span class="op">=</span>{<span class="st">&#39;154&#39;</span>:<span class="st">&#39;type&#39;</span>}, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="bu">print</span>(data_trn.head(<span class="dv">5</span>))</a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="bu">print</span>(data_trn.<span class="bu">type</span>.value_counts())</a>
<a class="sourceLine" id="cb7-17" data-line-number="17"></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">data_tst <span class="op">=</span> read_file(smart_open(path_test))</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="bu">print</span>(check_missing(data_tst))</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">data_tst.rename(columns<span class="op">=</span>{<span class="st">&#39;154&#39;</span>:<span class="st">&#39;type&#39;</span>}, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="bu">print</span>(data_tst.head(<span class="dv">5</span>))</a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="bu">print</span>(data_tst.<span class="bu">type</span>.value_counts())</a></code></pre>
</div>
<div id="perform-the-data-processing-specific-to-neural-networks" class="section level2">
<h2><span class="header-section-number">8.4</span> Perform the Data Processing Specific to Neural Networks</h2>
<ol start="100" style="list-style-type: decimal">
<li>Split the <strong>training set</strong> into a <strong>training part</strong> and a <strong>validation part</strong>:</li>
</ol>
<pre class="sourceCode python" id="cb8"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1">normal <span class="op">=</span> data_trn[data_trn.<span class="bu">type</span> <span class="op">==</span> <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">impersonation <span class="op">=</span> data_trn[data_trn.<span class="bu">type</span> <span class="op">==</span> <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">flooding <span class="op">=</span> data_trn[data_trn.<span class="bu">type</span> <span class="op">==</span> <span class="dv">3</span>]</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">injection <span class="op">=</span> data_trn[data_trn.<span class="bu">type</span> <span class="op">==</span> <span class="dv">4</span>]</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">normal_trn <span class="op">=</span> normal.sample(frac <span class="op">=</span> <span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">impersonation_trn <span class="op">=</span> impersonation.sample(frac <span class="op">=</span> <span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">flooding_trn <span class="op">=</span> flooding.sample(frac <span class="op">=</span> <span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">injection_trn <span class="op">=</span> injection.sample(frac <span class="op">=</span> <span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">train <span class="op">=</span> pd.concat([normal_trn, impersonation_trn, flooding_trn, injection_trn], axis <span class="op">=</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">validation <span class="op">=</span> data_trn.loc[<span class="op">~</span>data_trn.index.isin(train.index)]</a>
<a class="sourceLine" id="cb8-12" data-line-number="12"></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#shuffle the dataframes so that rows are in random order</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">train <span class="op">=</span> shuffle(train)</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">validation <span class="op">=</span> shuffle(validation)</a></code></pre>
<ol start="101" style="list-style-type: decimal">
<li><strong>Transform the class labels</strong> from a categorical variable to 4 dummy variables and <strong>check</strong> the correctness:</li>
</ol>
<pre class="sourceCode python" id="cb9"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" data-line-number="1">x_train, y_train <span class="op">=</span> transform(train)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">x_validation, y_validation <span class="op">=</span> transform(validation)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">x_test, y_test <span class="op">=</span> transform(data_tst)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"> <span class="co"># check to ensure that all of training and testing sets have correct shape</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="bu">print</span>(x_train.shape)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="bu">print</span>(y_train.shape)</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="bu">print</span>(x_validation.shape)</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="bu">print</span>(y_validation.shape)  </a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="bu">print</span>(x_test.shape)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="bu">print</span>(y_test.shape)  </a></code></pre>
</div>
<div id="create-a-multi-layer-perceptron-model-using-neural-networks" class="section level2">
<h2><span class="header-section-number">8.5</span> Create a Multi-Layer Perceptron Model Using Neural Networks</h2>
<ol start="102" style="list-style-type: decimal">
<li>Define <strong>parameters</strong> for your neural network:</li>
</ol>
<pre class="sourceCode python" id="cb10"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># parameters</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">learning_rate <span class="op">=</span> <span class="fl">0.005</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">data_size <span class="op">=</span> x_train.shape[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">batch_size <span class="op">=</span> <span class="dv">1150</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">training_epochs <span class="op">=</span> <span class="dv">2000</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">training_dropout <span class="op">=</span> <span class="fl">0.9</span></a></code></pre>
<ol start="103" style="list-style-type: decimal">
<li>Define the <strong>neural network configuration</strong>:</li>
</ol>
<pre class="sourceCode python" id="cb11"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># input place holders</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">x <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, [<span class="va">None</span>, x_train.shape[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">y <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, [<span class="va">None</span>, y_train.shape[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">rate <span class="op">=</span> tf.compat.v1.placeholder(tf.float32)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#weights, bias, and activation function for n layers</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">num_nodes <span class="op">=</span> <span class="bu">int</span>(x_train.shape[<span class="dv">1</span>] <span class="op">*</span> (<span class="dv">2</span> <span class="op">/</span> <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">w1 <span class="op">=</span> tf.Variable(tf.random.normal([x_train.shape[<span class="dv">1</span>], num_nodes], stddev <span class="op">=</span> <span class="fl">0.15</span>))</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">b1 <span class="op">=</span> tf.Variable(tf.random.normal([num_nodes]))</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">a1 <span class="op">=</span> tf.nn.relu(tf.matmul(x, w1) <span class="op">+</span> b1)</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">a1_out <span class="op">=</span> tf.nn.dropout(a1, rate <span class="op">=</span> rate)</a>
<a class="sourceLine" id="cb11-12" data-line-number="12"></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">w2 <span class="op">=</span> tf.Variable(tf.random.normal([num_nodes, y_train.shape[<span class="dv">1</span>]], stddev <span class="op">=</span> <span class="fl">0.15</span>))</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">b2 <span class="op">=</span> tf.Variable(tf.random.normal([y_train.shape[<span class="dv">1</span>]]))</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">z2 <span class="op">=</span> tf.matmul(a1_out, w2) <span class="op">+</span> b2</a>
<a class="sourceLine" id="cb11-16" data-line-number="16">a2 <span class="op">=</span> tf.nn.softmax(z2)</a></code></pre>
<p>If you define a multi-layer network with linear neurons, then the network will only be a linear function. To allow the network to capture non-linear properties, you can add an activation function at each layer. The activation functions could be ReLU, sigmoid, or tanh.<br />
104. Define a <strong>cost function</strong> and an <strong>optimizer</strong> to learn the <strong>weights</strong> and <strong>biases</strong>:</p>
<pre class="sourceCode python" id="cb12"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" data-line-number="1">cost <span class="op">=</span> tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits_v2(logits <span class="op">=</span> z2, labels <span class="op">=</span> y))</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">optimizer <span class="op">=</span> tf.compat.v1.train.AdamOptimizer(learning_rate <span class="op">=</span> learning_rate).minimize(cost)</a></code></pre>
<ol start="105" style="list-style-type: decimal">
<li>Define the <strong>evaluation metric</strong>:</li>
</ol>
<pre class="sourceCode python" id="cb13"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" data-line-number="1">pred <span class="op">=</span> tf.argmax(a2, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">correct <span class="op">=</span> tf.equal(tf.argmax(a2, <span class="dv">1</span>), tf.argmax(y, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">accuracy <span class="op">=</span> tf.reduce_mean(tf.cast(correct, tf.float32))</a></code></pre>
</div>
<div id="train-the-multi-layer-perceptron-model" class="section level2">
<h2><span class="header-section-number">8.6</span> Train the Multi-Layer Perceptron Model</h2>
<ol start="106" style="list-style-type: decimal">
<li>Set up the <strong>data structures</strong> and <strong>file paths</strong> to <strong>save the intermediate training results</strong>:</li>
</ol>
<pre class="sourceCode python" id="cb14"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># train model</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">train_accuracy_summary <span class="op">=</span> []</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">train_cost_summary <span class="op">=</span> []</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">valid_accuracy_summary <span class="op">=</span> []</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">valid_cost_summary <span class="op">=</span> []</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">stop_early <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">checkpoint1 <span class="op">=</span> <span class="st">&#39;./best_model_pca.ckpt&#39;</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">checkpoint2 <span class="op">=</span> <span class="st">&#39;./weights_pca.ckpt&#39;</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">saver <span class="op">=</span> tf.compat.v1.train.Saver(max_to_keep <span class="op">=</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">weights_saver <span class="op">=</span> tf.compat.v1.train.Saver(var_list <span class="op">=</span> [w1])</a></code></pre>
<p>We use the <strong>temporary storage</strong> associated with this EC2 Deep Learning instance to save the intermediate training results. Those results will be gone when the instance is terminated. It is not efficient to save those intermediate results to S3. Since the instance is run on Amazon Linux system (instead of Windows), please make sure to write down the correct file paths.<br />
107. Run the <strong>training loop</strong> with the defined parameters in step 102. We save the model and its associated weights only for the model with the highest validation accuracy. We also use an early stop criterion to stop the training loop early if the model has been trained long enough and the validation accuracy cannot be improved further in the next 20 loops.</p>
<pre class="sourceCode python" id="cb15"><code class="sourceCode python"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="cf">with</span> tf.compat.v1.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">    sess.run(tf.compat.v1.global_variables_initializer())</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(training_epochs):</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">        <span class="cf">for</span> batch <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">int</span>(data_size<span class="op">/</span>batch_size)):</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">            batch_x <span class="op">=</span> x_train[batch<span class="op">*</span>batch_size: (<span class="dv">1</span><span class="op">+</span>batch)<span class="op">*</span>batch_size]</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">            batch_y <span class="op">=</span> y_train[batch<span class="op">*</span>batch_size: (<span class="dv">1</span><span class="op">+</span>batch)<span class="op">*</span>batch_size]</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"></a>
<a class="sourceLine" id="cb15-9" data-line-number="9">            sess.run([optimizer], feed_dict <span class="op">=</span> {x: batch_x, y: batch_y, rate: <span class="dv">1</span> <span class="op">-</span> training_dropout})</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"></a>
<a class="sourceLine" id="cb15-11" data-line-number="11">        train_accuracy, train_cost <span class="op">=</span> sess.run([accuracy, cost], feed_dict <span class="op">=</span> {x: x_train, y: y_train, rate: <span class="dv">1</span> <span class="op">-</span> training_dropout})</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">        valid_accuracy, valid_cost <span class="op">=</span> sess.run([accuracy, cost], feed_dict <span class="op">=</span> {x: x_validation, y: y_validation, rate: <span class="dv">1</span> <span class="op">-</span> training_dropout})</a>
<a class="sourceLine" id="cb15-13" data-line-number="13"></a>
<a class="sourceLine" id="cb15-14" data-line-number="14">        <span class="bu">print</span>(<span class="st">&quot;Epoch:&quot;</span>, epoch,</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">              <span class="st">&quot;Train_Accuracy =&quot;</span>, <span class="st">&quot;</span><span class="sc">{:.5f}</span><span class="st">&quot;</span>.<span class="bu">format</span>(train_accuracy),</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">              <span class="st">&quot;Train_Cost =&quot;</span>, <span class="st">&quot;</span><span class="sc">{:.5f}</span><span class="st">&quot;</span>.<span class="bu">format</span>(train_cost), </a>
<a class="sourceLine" id="cb15-17" data-line-number="17">              <span class="st">&quot;Valid_Accuracy =&quot;</span>, <span class="st">&quot;</span><span class="sc">{:.5f}</span><span class="st">&quot;</span>.<span class="bu">format</span>(valid_accuracy),</a>
<a class="sourceLine" id="cb15-18" data-line-number="18">              <span class="st">&quot;Valid_Cost =&quot;</span>, <span class="st">&quot;</span><span class="sc">{:.5f}</span><span class="st">&quot;</span>.<span class="bu">format</span>(valid_cost))</a>
<a class="sourceLine" id="cb15-19" data-line-number="19"></a>
<a class="sourceLine" id="cb15-20" data-line-number="20">        <span class="cf">if</span> epoch <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> valid_accuracy <span class="op">&gt;</span> <span class="bu">max</span>(valid_accuracy_summary):</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">            saver.save(sess, checkpoint1)</a>
<a class="sourceLine" id="cb15-22" data-line-number="22">            weights_saver.save(sess, checkpoint2)</a>
<a class="sourceLine" id="cb15-23" data-line-number="23"></a>
<a class="sourceLine" id="cb15-24" data-line-number="24">        train_accuracy_summary.append(train_accuracy)</a>
<a class="sourceLine" id="cb15-25" data-line-number="25">        train_cost_summary.append(train_cost)</a>
<a class="sourceLine" id="cb15-26" data-line-number="26">        valid_accuracy_summary.append(valid_accuracy)</a>
<a class="sourceLine" id="cb15-27" data-line-number="27">        valid_cost_summary.append(valid_cost)</a>
<a class="sourceLine" id="cb15-28" data-line-number="28">       </a>
<a class="sourceLine" id="cb15-29" data-line-number="29">        <span class="cf">if</span> valid_accuracy <span class="op">&lt;</span> <span class="bu">max</span>(valid_accuracy_summary) <span class="kw">and</span> epoch <span class="op">&gt;</span> <span class="dv">1000</span>:</a>
<a class="sourceLine" id="cb15-30" data-line-number="30">            stop_early <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb15-31" data-line-number="31">            <span class="cf">if</span> stop_early <span class="op">==</span> <span class="dv">20</span>:</a>
<a class="sourceLine" id="cb15-32" data-line-number="32">                <span class="cf">break</span></a>
<a class="sourceLine" id="cb15-33" data-line-number="33">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb15-34" data-line-number="34">            stop_early <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb15-35" data-line-number="35"></a>
<a class="sourceLine" id="cb15-36" data-line-number="36">    <span class="bu">print</span>()</a>
<a class="sourceLine" id="cb15-37" data-line-number="37">    <span class="bu">print</span>(<span class="st">&quot;Optimization Finished!&quot;</span>)</a></code></pre>
</div>
<div id="evaluate-the-multi-layer-perceptron-model" class="section level2">
<h2><span class="header-section-number">8.7</span> Evaluate the Multi-Layer Perceptron Model</h2>
<ol start="108" style="list-style-type: decimal">
<li>We restore the <strong>best model</strong> saved from the training phase and run this model on the <strong>test set</strong> to get the testing accuracy.</li>
<li>We also restore the <strong>weights</strong> associated with the best model and then use them to calculate the <strong>importance score for each feature</strong> and print the scores out in the descending order.</li>
<li>We plot the feature importance and <strong>save the plot permanently to S3</strong> using the “<strong>smart_open</strong>” Python library. The following code covers the steps 108-110.</li>
</ol>
<pre class="sourceCode python" id="cb16"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="cf">with</span> tf.compat.v1.Session() <span class="im">as</span> sess:</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">    saver.restore(sess, checkpoint1)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">    weights_saver.restore(sess, checkpoint2)</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">    graph <span class="op">=</span> tf.compat.v1.get_default_graph()</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">    </a>
<a class="sourceLine" id="cb16-6" data-line-number="6">    training_accuracy <span class="op">=</span> sess.run(accuracy, feed_dict <span class="op">=</span> {x: x_train, y: y_train, rate: <span class="dv">1</span> <span class="op">-</span> training_dropout})</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    validation_accuracy <span class="op">=</span> sess.run(accuracy, feed_dict <span class="op">=</span> {x: x_validation, y: y_validation, rate: <span class="dv">0</span>})</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">    </a>
<a class="sourceLine" id="cb16-9" data-line-number="9">    <span class="bu">print</span>(<span class="st">&quot;Results using the best Validation_Accuracy:&quot;</span>)</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">    <span class="bu">print</span>(<span class="st">&quot;Training Accuracy =&quot;</span>, training_accuracy)</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">    <span class="bu">print</span>(<span class="st">&quot;Validation Accuracy =&quot;</span>, validation_accuracy)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13">    testing_prediction, testing_accuracy <span class="op">=</span> sess.run([pred, accuracy], feed_dict <span class="op">=</span> {x: x_test, y: y_test, rate: <span class="dv">0</span>})</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">    </a>
<a class="sourceLine" id="cb16-15" data-line-number="15">    <span class="bu">print</span>()</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">    <span class="bu">print</span>(<span class="st">&quot;Results using the best Validation_Accuracy:&quot;</span>)</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">    <span class="bu">print</span>(<span class="st">&quot;Testing Accuracy =&quot;</span>, testing_accuracy)</a>
<a class="sourceLine" id="cb16-18" data-line-number="18"></a>
<a class="sourceLine" id="cb16-19" data-line-number="19">    w1 <span class="op">=</span> w1.<span class="bu">eval</span>(session<span class="op">=</span>sess)</a>
<a class="sourceLine" id="cb16-20" data-line-number="20"> </a>
<a class="sourceLine" id="cb16-21" data-line-number="21">    df <span class="op">=</span> pd.DataFrame(w1)</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">    <span class="bu">print</span>(df.shape)</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">    <span class="bu">print</span>(df.head(<span class="dv">5</span>))</a>
<a class="sourceLine" id="cb16-24" data-line-number="24"></a>
<a class="sourceLine" id="cb16-25" data-line-number="25">    df.loc[:, <span class="st">&quot;sum&quot;</span>] <span class="op">=</span> df.<span class="bu">sum</span>(axis <span class="op">=</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb16-26" data-line-number="26">    <span class="bu">print</span>(df.head(<span class="dv">5</span>))</a>
<a class="sourceLine" id="cb16-27" data-line-number="27">    </a>
<a class="sourceLine" id="cb16-28" data-line-number="28"></a>
<a class="sourceLine" id="cb16-29" data-line-number="29">    dt_importances <span class="op">=</span> <span class="bu">abs</span>(df.loc[:, <span class="st">&quot;sum&quot;</span>].values)</a>
<a class="sourceLine" id="cb16-30" data-line-number="30">    dt_indices <span class="op">=</span> np.argsort(dt_importances)[:: <span class="dv">-1</span>]</a>
<a class="sourceLine" id="cb16-31" data-line-number="31">    <span class="bu">print</span>(<span class="st">&quot;Feature ranking:: ANN:&quot;</span>)</a>
<a class="sourceLine" id="cb16-32" data-line-number="32"></a>
<a class="sourceLine" id="cb16-33" data-line-number="33">    <span class="cf">for</span> f <span class="kw">in</span> <span class="bu">range</span>(x_train.shape[<span class="dv">1</span>]):</a>
<a class="sourceLine" id="cb16-34" data-line-number="34">        <span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">%d</span><span class="st">. feature </span><span class="sc">%d</span><span class="st"> importance (</span><span class="sc">%f</span><span class="st">)&quot;</span> <span class="op">%</span> (f <span class="op">+</span> <span class="dv">1</span>, dt_indices[f], dt_importances[dt_indices[f]]))</a>
<a class="sourceLine" id="cb16-35" data-line-number="35"></a>
<a class="sourceLine" id="cb16-36" data-line-number="36">    plt.figure()</a>
<a class="sourceLine" id="cb16-37" data-line-number="37">    plt.title(<span class="st">&quot;Feature importances:: ANN&quot;</span> )</a>
<a class="sourceLine" id="cb16-38" data-line-number="38">    plt.bar(<span class="bu">range</span>(x_train.shape[<span class="dv">1</span>]), dt_importances[dt_indices], color <span class="op">=</span> <span class="st">&quot;r&quot;</span>, align <span class="op">=</span> <span class="st">&quot;center&quot;</span>)</a>
<a class="sourceLine" id="cb16-39" data-line-number="39">    plt.xticks(<span class="bu">range</span>(x_train.shape[<span class="dv">1</span>]), dt_indices)</a>
<a class="sourceLine" id="cb16-40" data-line-number="40">    plt.xlim([<span class="op">-</span><span class="dv">1</span>, x_train.shape[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb16-41" data-line-number="41">    plt.savefig(<span class="st">&#39;./importance.png&#39;</span>)</a>
<a class="sourceLine" id="cb16-42" data-line-number="42"></a>
<a class="sourceLine" id="cb16-43" data-line-number="43">    importance_key <span class="op">=</span> <span class="st">&#39;feature_importance.png&#39;</span></a>
<a class="sourceLine" id="cb16-44" data-line-number="44">    imp_graph_path <span class="op">=</span> <span class="st">&#39;s3://</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">@</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(aws_key, aws_secret, bucket_name, importance_key)</a>
<a class="sourceLine" id="cb16-45" data-line-number="45">    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;./importance.png&#39;</span>, <span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</a>
<a class="sourceLine" id="cb16-46" data-line-number="46">        content <span class="op">=</span> f.read()</a>
<a class="sourceLine" id="cb16-47" data-line-number="47">    <span class="cf">with</span> <span class="bu">open</span>(imp_graph_path, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> fout:</a>
<a class="sourceLine" id="cb16-48" data-line-number="48">        fout.write(content)</a></code></pre>
<ol start="111" style="list-style-type: decimal">
<li>Finally, we also plot the training vs. validation accuracy and the training vs. validation cost over the entire training epochs and <strong>save the plot permanently to S3</strong> using the “<strong>smart_open</strong>” Python library.</li>
</ol>
<pre class="sourceCode python" id="cb17"><code class="sourceCode python"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># Plot accuracy and cost summaries</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">f, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, sharex <span class="op">=</span> <span class="va">True</span>, figsize <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">ax1.plot(train_accuracy_summary) <span class="co"># blue</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">ax1.plot(valid_accuracy_summary) <span class="co"># green</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">ax1.set_title(<span class="st">&#39;Accuracy&#39;</span>)</a>
<a class="sourceLine" id="cb17-7" data-line-number="7"></a>
<a class="sourceLine" id="cb17-8" data-line-number="8">ax2.plot(train_cost_summary) <span class="co"># blue</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9">ax2.plot(valid_cost_summary) <span class="co"># green</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10">ax2.set_title(<span class="st">&#39;Cost&#39;</span>)</a>
<a class="sourceLine" id="cb17-11" data-line-number="11"></a>
<a class="sourceLine" id="cb17-12" data-line-number="12">plt.xlabel(<span class="st">&#39;Epochs&#39;</span>)</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">plt.savefig(<span class="st">&#39;./epochs.png&#39;</span>)</a>
<a class="sourceLine" id="cb17-14" data-line-number="14"></a>
<a class="sourceLine" id="cb17-15" data-line-number="15">epoch_key <span class="op">=</span> <span class="st">&#39;training_epoch.png&#39;</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16">epoch_graph_path <span class="op">=</span> <span class="st">&#39;s3://</span><span class="sc">{}</span><span class="st">:</span><span class="sc">{}</span><span class="st">@</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(aws_key, aws_secret, bucket_name, epoch_key)</a>
<a class="sourceLine" id="cb17-17" data-line-number="17"><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;./epochs.png&#39;</span>, <span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</a>
<a class="sourceLine" id="cb17-18" data-line-number="18">    content <span class="op">=</span> f.read()</a>
<a class="sourceLine" id="cb17-19" data-line-number="19"><span class="cf">with</span> smart_open(epoch_graph_path, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> fout:</a>
<a class="sourceLine" id="cb17-20" data-line-number="20">    fout.write(content)</a></code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="explore-amazon-deep-learning-ami-and-connect-to-a-jupyter-notebook.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="get-the-results-locally.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/IQSS/dss-template/edit/master/part_8.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["template.pdf", "template.epub"],
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

</body>

</html>
